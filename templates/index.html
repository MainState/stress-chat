
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>스트레스 평가 대화</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #chat-section, #results-section { padding: 20px; }
        #chat-box { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
        #user-input { width: 80%; padding: 8px; margin-right: 10px; }
        #send-button { padding: 8px 15px; }
        #score-display { margin-top: 20px; font-weight: bold; }
        #results-section { text-align: center; }
        #final-score-value { font-size: 3em; font-weight: bold; color: #2c3e50; margin: 30px 0; }
        #try-again-button { padding: 10px 20px; font-size: 1.2em; background-color: #3498db; color: white; border: none; cursor: pointer; border-radius: 5px; }
        #try-again-button:hover { background-color: #2980b9; }
        .disclaimer { color: #7f8c8d; font-style: italic; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="chat-section">
        <div id="chat-box"></div>
        <div>
            <input type="text" id="user-input" placeholder="메시지를 입력하세요...">
            <button id="send-button">전송</button>
        </div>
        <div id="turn-indicator" style="margin-bottom: 5px; font-size: 0.9em; color: grey;">대화 시작 중...</div>
        <div id="score-display"></div>
    </div>

    <div id="results-section" style="display: none;">
        <h2>최종 스트레스 평가 결과</h2>
        <p id="final-score-value"></p>
        <p class="disclaimer">본 점수는 참고용이며 의학적 진단을 대체할 수 없습니다.<br>전문적인 상담이 필요하시다면 전문가와 상담하시기 바랍니다.</p>
        <button id="try-again-button">처음부터 다시 시작하기</button>
    </div>
    
    <script>
        const chatSection = document.getElementById('chat-section');
        const resultsSection = document.getElementById('results-section');
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const scoreDisplay = document.getElementById('score-display');
        const finalScoreValueElement = document.getElementById('final-score-value');
        const tryAgainButton = document.getElementById('try-again-button');
        const turnIndicator = document.getElementById('turn-indicator');

        // Try Again 버튼 이벤트 리스너
        tryAgainButton.addEventListener('click', () => {
            window.location.reload();
        });

        sendButton.addEventListener('click', async () => {
            const userMessage = userInput.value.trim();
            
            if (userMessage) {
                chatBox.innerHTML += `<p>나: ${userMessage}</p>`;
                userInput.value = '';

                try {
                    const response = await fetch('/send_message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ message: userMessage })
                    });

                    const data = await response.json();
                    
                    // 턴 카운터 업데이트
                    if (turnIndicator && data.current_turn !== undefined && data.max_turns !== undefined) {
                        turnIndicator.textContent = `현재 진행: ${data.current_turn} / ${data.max_turns} 턴`;
                    }

                    if (data.conversation_end === true) {
                        console.log("Conversation ended. Switching to results screen. Data:", data);
                        // 채팅 섹션 숨기고 결과 섹션 표시
                        chatSection.style.display = 'none';
                        resultsSection.style.display = 'block';
                        finalScoreValueElement.textContent = data.stress_score + "점";
                        if (turnIndicator) {
                            turnIndicator.style.display = 'none';
                        }
                    } else {
                        // 대화 계속 진행
                        chatSection.style.display = 'block';
                        resultsSection.style.display = 'none';
                        chatBox.innerHTML += `<p>챗봇: ${data.reply}</p>`;
                        
                        // 점수 표시 업데이트
                        if (scoreDisplay) {
                            scoreDisplay.textContent = `현재 스트레스 점수: ${data.stress_score} / 10`;
                        }
                        
                        // 입력 활성화 유지
                        userInput.disabled = false;
                        sendButton.disabled = false;
                    }
                    
                    // 스크롤 최하단으로 이동
                    chatBox.scrollTop = chatBox.scrollHeight;
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        });

        // Enter 키 입력 처리
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        // 다시 시작하기 버튼 처리
        tryAgainButton.addEventListener('click', () => {
            window.location.reload();
        });
    </script>
</body>
</html>
