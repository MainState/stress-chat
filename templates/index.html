
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>스트레스 평가 대화</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #chat-section, #results-section { padding: 20px; }
        #chat-box { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
        #user-input { width: 80%; padding: 8px; margin-right: 10px; }
        #send-button { padding: 8px 15px; }
        #score-display { margin-top: 20px; font-weight: bold; }
        #results-section { text-align: center; }
        #final-score-value { font-size: 3em; font-weight: bold; color: #2c3e50; margin: 30px 0; }
        #try-again-button { padding: 10px 20px; font-size: 1.2em; background-color: #3498db; color: white; border: none; cursor: pointer; border-radius: 5px; }
        #try-again-button:hover { background-color: #2980b9; }
        .disclaimer { color: #7f8c8d; font-style: italic; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="chat-section">
        <div id="chat-box"></div>
        <div>
            <input type="text" id="user-input" placeholder="메시지를 입력하세요...">
            <button id="send-button">전송</button>
        </div>
        <div id="turn-indicator" style="margin-bottom: 5px; font-size: 0.9em; color: grey;">대화 시작 중...</div>
        <div id="score-display"></div>
    </div>

    <div id="results-section" style="display: none;">
        <h2>최종 스트레스 평가 결과</h2>
        <p id="final-score-value"></p>
        <p class="disclaimer">본 점수는 참고용이며 의학적 진단을 대체할 수 없습니다.<br>전문적인 상담이 필요하시다면 전문가와 상담하시기 바랍니다.</p>
        <button id="try-again-button">처음부터 다시 시작하기</button>
    </div>
    
    <script>
        const chatSection = document.getElementById('chat-section');
        const resultsSection = document.getElementById('results-section');
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const turnIndicator = document.getElementById('turn-indicator');
        const scoreDisplay = document.getElementById('score-display');
        const finalScoreValueElement = document.getElementById('final-score-value');
        const tryAgainButton = document.getElementById('try-again-button');

        async function sendMessage() {
            const userMessage = userInput.value.trim();
            if (userMessage === "") {
                return;
            }

            console.log("Frontend: User input received:", userMessage);

            const cheatCodeMatch = userMessage.match(/^\/setturn\s+(\d+)$/);
            console.log("Frontend: Cheat code match result:", cheatCodeMatch);

            if (cheatCodeMatch) {
                console.log("Frontend: CHEAT CODE detected. Processing for cheat path...");
                userInput.value = "";

                const targetTurn = parseInt(cheatCodeMatch[1], 10);
                const payload = {
                    cheat_command: "set_turn",
                    target_turn: targetTurn
                };
                console.log("Frontend: Sending CHEAT payload to backend:", payload);

                try {
                    const response = await fetch('/send_message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log("Frontend: Received response for CHEAT command from backend:", data);

                    chatBox.innerHTML = '';

                    if (data.reply) {
                        const systemMessageP = document.createElement('p');
                        systemMessageP.innerHTML = `<strong>[시스템]</strong> ${data.reply}`;
                        chatBox.appendChild(systemMessageP);
                    }

                    if (turnIndicator && data.current_turn !== undefined && data.max_turns !== undefined) {
                        turnIndicator.textContent = `현재 진행: ${data.current_turn} / ${data.max_turns} 턴`;
                    }

                    if (scoreDisplay && data.stress_score !== undefined) {
                        scoreDisplay.textContent = `현재 추정 스트레스 점수: ${data.stress_score} / 10`;
                    }
                    
                    if (data.conversation_end === true) {
                        console.log("Frontend: CHEAT caused conversation end. Switching to results screen.");
                        chatSection.style.display = 'none';
                        resultsSection.style.display = 'block';
                        finalScoreValueElement.textContent = data.stress_score + "점";
                        if (turnIndicator) turnIndicator.textContent = "대화 종료됨";
                        userInput.disabled = true;
                        sendButton.disabled = true;
                    } else {
                        userInput.disabled = false;
                        sendButton.disabled = false;
                    }

                } catch (error) {
                    console.error('Frontend: Error processing CHEAT command:', error);
                    const errorP = document.createElement('p');
                    errorP.textContent = `치트 코드 처리 오류: ${error.message}`;
                    errorP.style.color = 'red';
                    chatBox.appendChild(errorP);
                }

            } else {
                console.log("Frontend: NORMAL message detected. Sending:", userMessage);

                const userP = document.createElement('p');
                userP.textContent = `나: ${userMessage}`;
                chatBox.appendChild(userP);
                chatBox.scrollTop = chatBox.scrollHeight;

                userInput.value = "";

                try {
                    const response = await fetch('/send_message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: userMessage })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log("Frontend: Received response for NORMAL command from backend:", data);

                    if (data.reply) {
                        const botP = document.createElement('p');
                        botP.textContent = `챗봇: ${data.reply}`;
                        chatBox.appendChild(botP);
                    }

                    if (turnIndicator && data.current_turn !== undefined && data.max_turns !== undefined) {
                        turnIndicator.textContent = `현재 진행: ${data.current_turn} / ${data.max_turns} 턴`;
                    }

                    if (scoreDisplay && data.stress_score !== undefined) {
                        scoreDisplay.textContent = `현재 추정 스트레스 점수: ${data.stress_score} / 10`;
                    }

                    if (data.conversation_end === true) {
                        console.log("Frontend: NORMAL conversation ended. Switching to results screen.");
                        chatSection.style.display = 'none';
                        resultsSection.style.display = 'block';
                        finalScoreValueElement.textContent = data.stress_score + "점";
                        if (turnIndicator) turnIndicator.textContent = "대화 종료됨";
                        userInput.disabled = true;
                        sendButton.disabled = true;
                    } else {
                        userInput.disabled = false;
                        sendButton.disabled = false;
                    }

                } catch (error) {
                    console.error('Frontend: Error processing NORMAL command:', error);
                    const errorP = document.createElement('p');
                    errorP.textContent = `오류: ${error.message}`;
                    errorP.style.color = 'red';
                    chatBox.appendChild(errorP);
                }
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 이벤트 리스너 설정
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        tryAgainButton.addEventListener('click', () => {
            window.location.reload();
        });
    </script>
</body>
</html>
